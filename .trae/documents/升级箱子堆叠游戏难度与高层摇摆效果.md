## 目标
- 增加难度：尺寸不再线性固定缩小，改为区间随机并随层数/得分递进。
- 高层摇摆：当堆叠高度较高时，顶层或顶部若干层产生轻微周期性摇摆（水平+旋转），模拟高楼层的晃动。
- 投放高度效应：层数越高，箱子出生更高，下落距离更长，着陆更具挑战。

## 改动范围
- `src/App.tsx`：生成与投放逻辑、`gameLoop` 注入摇摆与高度影响、尺寸区间随机。
- `src/types.ts`：集中定义难度档位及参数（尺寸范围、摇摆幅度/频率、投放高度增量、落顶容错）。
- `src/PhysicsEngine.ts`：可选（最小改动优先）：保留现实现，摇摆与难度由 `App.tsx` 在每帧注入速度/旋转速度实现；若需要更平滑可在此增加小扰动项。

## 关键代码位置（参考）
- 尺寸与投放：`src/App.tsx:259-260` 当前线性缩小逻辑。
- 投放数据构造：`src/App.tsx:240-256` 构造 `fallingBox`（位置/尺寸/初始速度/旋转）。
- 主循环：`src/App.tsx:52-168` `gameLoop` 每帧更新。
- 物理更新：`src/PhysicsEngine.ts:4-13` `updateBox` 使用 `GRAVITY/FRICTION`。
- 稳定性分析：`src/PhysicsEngine.ts:145` `analyzeStackStability`（可保留）。
- 预览与渲染：`src/components/GameCanvas.tsx:99-140`（展示效果，逻辑不改）。

## 详细方案（伪代码）
### 1) 难度配置
```pseudo
// src/types.ts
type DifficultyConfig = {
  widthRangeForLevel(level): [minW, maxW]
  heightRangeForLevel(level): [minH, maxH]
  spawnHeightOffset(level): number // 每层增加的出生高度
  wobbleAmplitude(level): { vx: number, rotVel: number }
  wobbleFrequency(level): { vxHz: number, rotHz: number }
  minOverlapRatio(level): number // 越高越严格（如 0.6 → 0.7）
}
DIFFICULTY = { normal: ..., hard: ... }
```
- 默认 `normal`；随 `boxes.length`/`score` 提升实际“level”。

### 2) 尺寸区间随机（替换线性缩小）
```pseudo
// src/App.tsx at 259-260
function computeNextBoxSize(level, difficulty): { w, h } {
  [wMin, wMax] = difficulty.widthRangeForLevel(level)
  [hMin, hMax] = difficulty.heightRangeForLevel(level)
  w = randomBetween(wMin, wMax)
  h = randomBetween(hMin, hMax)
  return { w: clamp(w, 30, GAME_WIDTH/3), h: clamp(h, 20, GAME_HEIGHT/10) }
}
nextBoxWidth = size.w
nextBoxHeight = size.h
```
- 引入宽高的随机性与范围递进，提高操控难度与多样性。

### 3) 投放高度效应（层数越高，出生更高）
```pseudo
// src/App.tsx around fallingBox构造
level = boxes.length
spawnOffset = difficulty.spawnHeightOffset(level) // 比如 10px 基础 + 每层增加 15px
fallingBox.y = -cameraY - spawnOffset
// 可选：初始 rotation 按层数略增，增强落地挑战
fallingBox.rotation += randomSmallAngle(level)
```
- 更高的出生点带来更大下落动能，更难稳定着陆。

### 4) 高层摇摆（顶部若干层周期性扰动）
```pseudo
// src/App.tsx in gameLoop
if (boxes.length >= WOBBLE_THRESHOLD) {
  t = currentTime / 1000
  topN = selectTopNBoxes(boxes, N=2~3)
  for each b in topN {
    amp = difficulty.wobbleAmplitude(levelOf(b))
    freq = difficulty.wobbleFrequency(levelOf(b))
    b.velocityX += amp.vx * sin(2π * freq.vxHz * t + phase(b)) * dtSec
    b.rotationVelocity += amp.rotVel * sin(2π * freq.rotHz * t + phase(b)) * dtSec
  }
}
```
- 通过每帧注入小幅 `velocityX/rotationVelocity` 正弦扰动，视觉上产生高层“晃动”。
- 采用与层数相关的幅度/频率，顶部更明显，底部不影响。

### 5) 落顶容错递进（可选，保守逐步开启）
```pseudo
// 在 App.tsx 的落顶成功判定处，或向 PhysicsEngine 传入动态阈值
requiredOverlap = difficulty.minOverlapRatio(level)
// 用 requiredOverlap 替换固定常量 MIN_OVERLAP_RATIO
```
- 难度升高时提高重叠要求，减少“擦边上塔”的成功率。
- 初次实现可保持现有阈值不变，先验证摇摆与高度效果。

### 6) 难度推进策略
```pseudo
// level 计算
level = clamp(floor(boxes.length / 3), 0, MAX_LEVEL)
// 或使用 score 作为替代指标
```
- 简单线性推进；后续可改为非线性或基于失败次数调整。

## 验证与调参
- 本地运行，快速叠到 6~8 层：
  - 观察顶部箱子是否出现轻微晃动（非过度导致必倒）。
  - 随层数尺寸是否更难对齐（宽度、厚度的随机差异）。
  - 投放高度随层数明显提升，着陆更“冲击”。
- 调参建议：
  - 初始 `WOBBLE_THRESHOLD=5` 层，`amp.vx≈5~15 px/s`，`amp.rotVel≈2~6 deg/s`，`freq≈0.6~1.2 Hz`。
  - `spawnHeightOffset` 每层 12~20px。
  - 尺寸范围：宽 `60~90`（低层）递进到 `40~70`（高层）；高 `30~45` 到 `22~35`。

## 实施步骤（无副作用说明）
1. 在 `src/types.ts` 增加难度配置类型与默认参数，不改变现有导出常量。
2. 修改 `src/App.tsx:259-260` 使用 `computeNextBoxSize(...)` 生成随机尺寸。
3. 修改 `src/App.tsx:240-246` 投放点 `y` 按层数提升；可微调初始旋转。
4. 在 `src/App.tsx:52-168` 的 `gameLoop` 中对顶部若干层注入周期性扰动。
5. 保留 `PhysicsEngine` 现有稳定性分析，必要时二期再引入动态 `minOverlapRatio`。

## 交付与回滚
- 代码改动集中在 `App.tsx` 与 `types.ts`，可一键回退为线性缩小与固定出生点。
- 提供参数开关：`enableWobble`, `enableSpawnHeightEffect`, `difficulty='normal'|'hard'`，便于快速比对效果。