## 目标
- 当某个箱子倾斜角度过大或质心越过支撑边界时，围绕支撑边缘作为“枢轴点”进行真实的物理倒塌模拟（角加速度、角速度、位置随旋转更新），并对其上方箱子产生连锁影响。

## 集成点
- `src/PhysicsEngine.ts`：在稳定性分析返回 `reason: 'tip'` 时，给相关箱子标记“倾覆状态”，计算枢轴点并按帧更新旋转与位置。
- `src/App.tsx`：接收 `analyzeStackStability` 的结果，设置需要倾覆的箱子，维持逐帧更新、碰撞与结束判定。

## 数据扩展
- 为 `Box` 增加可选字段：`isTipping?: boolean`、`pivotX?: number`、`pivotY?: number`。
- 这些字段仅在倾覆阶段使用，正常阶段不影响现有逻辑。

## 触发与枢轴选择
- 触发条件：
  - 稳定性分析返回 `reason: 'tip'`（src/PhysicsEngine.ts:145–176）。
  - 或 `Math.abs(rotation) > tiltThreshold`（保留当前 30° 判定但将其用于触发倾覆，而非直接结束）。
- 枢轴点选择：
  - 使用 `analysis.range = [L, R]` 与 `analysis.comX`，当 `comX > R` 选择右边缘；当 `comX < L` 选择左边缘。
  - 枢轴 Y 为支撑箱顶面 `support.y`，X 为对应边缘位置。

## 倾覆动力学
- 物理量：
  - 质量 `m = width * height`；惯性矩 `I = (1/12) * m * (width^2 + height^2)`（矩形绕中心）。
  - 距枢轴的水平距离 `dx = |COM_x - pivotX|`。
  - 力矩 `tau = m * g * dx`；角加速度 `alpha = tau / I`。
- 帧更新（伪代码）：
  - `rotationVelocity += dir * alpha * dt`（`dir` 由 `comX` 相对 `pivotX` 的方向决定）。
  - `rotation += rotationVelocity * dt`。
  - 以枢轴点为中心更新箱子中心：
    - `cx = x + width/2; cy = y + height/2;`
    - `vx = cx - pivotX; vy = cy - pivotY;`
    - `vx', vy' = rotate(vx, vy, rotationDelta)`；
    - `cx' = pivotX + vx'; cy' = pivotY + vy';`
    - `x = cx' - width/2; y = cy' - height/2;`
  - 角速度与水平速度应用阻尼：`rotationVelocity *= FRICTION^frameFactor`。
- 结束/脱离枢轴条件：
  - 当箱子一角或边与支撑脱离（`overlapW <= 0`）或 `rotation` 超过一定阈值（例如 90°），移除 `isTipping`，设置 `isMoving = true`，进入自由下落阶段。

## 连锁影响与上层箱子
- 当第 `failingIndex` 倾覆：
  - 对其上的箱子（索引 `> failingIndex`）施加扰动：小的水平速度与角速度（已有基础逻辑，src/App.tsx:188–209），并逐帧重新计算稳定性，出现 `slide/tip` 则继续标记各自倾覆或下落。

## 碰撞与地面交互
- 与地面或其他箱子的碰撞沿用现有 `resolveCollision`。
- 在倾覆阶段优先保持枢轴点在支撑边缘，当检测到实际碰撞或支撑消失时转入普通碰撞处理。

## 渲染适配
- 保持 `GameCanvas` 以箱子中心旋转的绘制方式（src/components/GameCanvas.tsx:103–116）。
- 通过物理更新时围绕枢轴旋转后重设 `x,y`，使得渲染无需修改即可体现绕枢轴旋转的效果。

## 验证与日志
- 继续使用已添加的调试日志：
  - 新增 `tipping_start`（包含 `pivotX/pivotY/failingIndex/reason`）、`tipping_update`（逐帧 `alpha/rotationVelocity/rotation`）、`tipping_release`（转自由下落时）。
- 通过多案例验证：
  - 质心越界右侧、左侧；宽高不同的箱子；高层多箱连锁。

## 改动清单
- `types.ts`：扩展 `Box` 类型（添加三个可选字段）。
- `PhysicsEngine.ts`：
  - 倾覆启动：根据 `analyzeStackStability` 的 `tip` 与当前角度阈值设置 `isTipping/pivotX/pivotY`。
  - 倾覆更新：新增更新分支计算 `alpha` 并围绕枢轴更新 `x,y,rotation`。
  - 释放条件：当接触丧失或旋转超过阈值，清理倾覆状态，转为下落。
- `App.tsx`：
  - 接收 `analysis` 并对 `failingIndex` 的箱子设置倾覆状态。
  - 保持现有连锁扰动逻辑，对上层箱子逐帧检查与处理。

## 风险与回退
- 若倾覆模拟过于剧烈，调小 `alpha` 系数或增加阻尼。
- 保留原有简化判定作为兜底，确保不会引入卡死或穿透。

## 产出
- 更真实的倾覆动画与物理行为，用户能感知到从支撑边缘开始的倒塌过程，并伴随上层连锁效应。