## 目标
- 在关键判定点打印结构化日志，定位“看起来放置正常但游戏立即结束”的原因。
- 不改动游戏逻辑，仅增加可控的调试输出，覆盖：放置失败原因、塔稳定性分析、旋转与支撑判定、限时/数量模式触发。

## 可能原因
- 接受落顶阈值与稳定性阈值不一致：放置接受使用 `overlapRatio >= 0.5`（src/App.tsx:132），而稳定性使用 `MIN_OVERLAP_RATIO = 0.6`（src/types.ts:26）。50% 接触被接受，但随后被稳定性判为滑落导致 `gameOver`。
- 质心越界：`COM_x` 超出支撑区间并考虑 `TIP_MARGIN_PX = 6`（src/PhysicsEngine.ts:168–170）。
- 旋转过大：`Math.abs(box.rotation) > 30` 直接不稳定（src/PhysicsEngine.ts:101–106）。
- 支撑不足：上方箱子与下方支撑的水平/垂直接触不足（src/PhysicsEngine.ts:126–137）。
- 模式触发：限时或数量模式（src/App.tsx:234–246）。

## 伪代码（日志点位）
- 定义 `DEBUG` 与 `log(event, data)`：
  - `const DEBUG = true; const log = (e, d) => DEBUG && console.log('[STACK]', e, d);`
- 掉落/放置阶段（src/App.tsx:100–173）：
  - 地面碰撞：当 `newFallingBox.y + height >= groundY` → `placementFailed = true`，`log('placement_failed_ground', { id, x, y, height, groundY })`。
  - 与非上一个箱子碰撞：循环检测命中 → `placementFailed = true`，`log('placement_failed_other_collision', { fallingId, collideWithId })`。
  - 合法接触但落顶失败：计算 `overlapRatio` 与顶面条件不满足 → `placementFailed = true`，`log('placement_failed_insufficient_overlap', { ratio, lastId, fallingId, leftA, rightA, leftB, rightB })`。
  - 成功落顶：`log('placed', { id, ratio, x, y, width, height })`。
- 叠塔稳定性分析（src/App.tsx:180–188 与 src/PhysicsEngine.ts:145–176）：
  - `const analysis = analyzeStackStability(newBoxes)` 后：
    - 若 `!analysis.stable` → `log('stack_unstable', { failingIndex, reason, comX, range, topWidth, overlapW, MIN_OVERLAP_RATIO, TIP_MARGIN_PX })`。
- 最终稳定性与 `gameOver`（src/App.tsx:212–247）：
  - `const isStable = !placementFailed && PhysicsEngine.checkTowerStability(newBoxes)`。
  - 当 `!isStable`：
    - 读取 `checkTowerStability` 细节：
      - 若存在 `rotation > 30` → `log('unstable_rotation', { id, rotation })`（遍历 `boxes`）。
      - 支撑集合与未支撑箱子 → `log('unstable_support', { unsupportedIds })`（对支撑判定规则进行同样遍历并记录命中条件）。
  - 模式触发：
    - `limitedFail` → `log('mode_limited_fail', { maxBoxes, length })`
    - `timedFail` → `log('mode_timed_fail', { timeLeft })`
- UI层落地回调（src/App.tsx:395–404）：
  - 使用 `onBoxLanded` 输出：`log('box_landed', { id, precision, x, y, width, height })`。

## 具体改动点（文件与行号）
- `src/App.tsx`
  - 在组件顶部加入 `DEBUG` 与 `log`（建议靠近 `useState` 后，便于复用）。
  - 在以下位置插入日志：
    - 地面碰撞：`src/App.tsx:100–104`
    - 非上一个箱子碰撞：`src/App.tsx:112–121`
    - 落顶失败/成功：`src/App.tsx:123–173`
    - 稳定性分析与警告标记：`src/App.tsx:180–188`
    - 计算 `isStable` 并决定 `gameOver`：`src/App.tsx:212–247`
    - `onBoxLanded`：`src/App.tsx:399–404`（已存在，可补充更多字段）
- `src/PhysicsEngine.ts`
  - 在 `updateBox` 地面碰撞调整处记录：`src/PhysicsEngine.ts:19–31`
  - 在 `checkTowerStability` 中：
    - 旋转阈值命中：`src/PhysicsEngine.ts:101–106`
    - 支撑集合与未支撑箱记录：`src/PhysicsEngine.ts:111–141`
  - 在 `analyzeStackStability` 返回不稳定路径前记录：`src/PhysicsEngine.ts:158–173`

## 示例日志
- 放置失败（接触不足）：
  - `[STACK] placement_failed_insufficient_overlap { ratio: 0.52, fallingId: 7, lastId: 6, range: [L, R] }`
- 叠塔不稳定（滑落）：
  - `[STACK] stack_unstable { failingIndex: 5, reason: 'slide', overlapW: 43, topWidth: 90, MIN_OVERLAP_RATIO: 0.6 }`
- 叠塔不稳定（倾覆）：
  - `[STACK] stack_unstable { failingIndex: 3, reason: 'tip', comX: 312, range: [295, 305], TIP_MARGIN_PX: 6 }`
- 旋转过大：
  - `[STACK] unstable_rotation { id: 8, rotation: 34.2 }`
- 模式触发：
  - `[STACK] mode_timed_fail { timeLeft: 0 }`

## 执行步骤
1. 在 `src/App.tsx` 顶部添加 `DEBUG` 与 `log` 方法。
2. 按上述行号在关键分支插入 `log(...)`。
3. 在 `onBoxLanded` 扩展输出 `precision` 与落点坐标。
4. 在 `src/PhysicsEngine.ts` 的三个函数中添加对应日志，便于区分是稳定性分析导致，还是底层支撑/旋转规则导致。
5. 运行后重现“看起来放置正常但结束”的场景，依据日志判断：
   - 若 `placed` 的 `ratio` 在 0.5–0.6 之间，随后出现 `stack_unstable`，则为阈值不一致导致的结束。
   - 若出现 `tip`，关注 `comX` 与 `[L,R]`；若出现 `slide`，关注 `overlapW` 与 `top.width`。
   - 若出现 `unstable_rotation` 或 `unstable_support`，针对对应箱子修正规则或视觉提示。

## 后续可选优化（不在本次日志改动内）
- 对齐阈值：将 `MIN_OVERLAP_RATIO` 调整为 `0.5` 或提高落顶接受阈值到 `0.6`，避免“放置成功但立即结束”的体验落差。
- 在 UI 以提示条显示最近一次 `precision` 与阈值比较，帮助玩家理解失败原因。